<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>互动小说阅读器</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 自定义样式 */
        body, html {
            overscroll-behavior: none; /* 防止移动端下拉刷新 */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .safe-area-pb {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* 动画关键帧模拟 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-in {
            animation: fadeIn 0.2s ease-out forwards;
        }
        @keyframes slideInFromRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .slide-in-right {
            animation: slideInFromRight 0.3s ease-out forwards;
        }
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .zoom-in-95 {
            animation: zoomIn 0.2s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900 text-base antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 图标组件 ---
        const MoreHorizontal = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
        );
        const RotateCcw = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg>
        );
        const ChevronLeft = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        );
        const SearchIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        );
        const PlusIcon = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        );
        const FileIcon = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
        );

        // --- 核心逻辑 ---

        // 解析单个剧本
        const parseSingleScriptData = (text) => {
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
            const data = { scenes: {}, branches: {}, startSceneId: null };
            
            let currentBlockId = null;
            let currentBlockType = null;
            let currentLines = [];
            let lastSpeaker = '旁白'; 

            const saveCurrentBlock = () => {
                if (currentBlockId && currentLines.length > 0) {
                    const block = { lines: [...currentLines] };
                    if (currentBlockType === 'scene') {
                        data.scenes[currentBlockId] = block;
                        if (!data.startSceneId) data.startSceneId = currentBlockId;
                    } else {
                        data.branches[currentBlockId] = block;
                    }
                }
                currentLines = [];
            };

            let i = 0;
            while (i < lines.length) {
                const line = lines[i];

                if (line.match(/<SCENE id="([^"]+)">/)) {
                    saveCurrentBlock();
                    currentBlockId = line.match(/<SCENE id="([^"]+)">/)[1];
                    currentBlockType = 'scene';
                    lastSpeaker = '旁白';
                    i++; continue;
                }
                if (line.match(/<BRANCH from="([^"]+)">/)) {
                    saveCurrentBlock();
                    currentBlockId = line.match(/<BRANCH from="([^"]+)">/)[1];
                    currentBlockType = 'branch';
                    i++; continue;
                }
                if (line.startsWith('<CHOICE')) {
                    const options = [];
                    i++; 
                    while (i < lines.length && !lines[i].startsWith('</CHOICE>')) {
                        const optMatch = lines[i].match(/id="([^"]+)">([^<]+)<\//);
                        if (optMatch) options.push({ id: optMatch[1], text: optMatch[2] });
                        i++;
                    }
                    currentLines.push({ type: 'choice', options });
                    i++; continue;
                }
                const gotoMatch = line.match(/<GOTO scene="([^"]+)"\s*\/>/);
                if (gotoMatch) {
                    currentLines.push({ type: 'goto', targetScene: gotoMatch[1] });
                    i++; continue;
                }
                if (line.includes('【结局')) {
                    const endMatch = line.match(/【(.*?)】\[(.*?)\]\s*[—-]+\s*(.*)/);
                    currentLines.push({
                        type: 'ending',
                        endingTitle: endMatch ? `【${endMatch[1]}】${endMatch[2]}` : line,
                        endingEval: endMatch ? endMatch[3] : ''
                    });
                    i++; continue;
                }
                if (line.startsWith('</BRANCH>') || line.startsWith('</ENDING>') || line.startsWith('</NOVEL>')) {
                    i++; continue;
                }
                if (line.startsWith('[') && line.endsWith(']')) {
                    currentLines.push({ type: 'state', content: line.slice(1, -1) });
                    i++; continue;
                }
                
                const colonIndex = line.indexOf(':');
                const zhColonIndex = line.indexOf('：');
                let speaker = lastSpeaker;
                let content = line;
                const splitIndex = (zhColonIndex > -1 && (colonIndex === -1 || zhColonIndex < colonIndex)) ? zhColonIndex : colonIndex;

                if (splitIndex > -1 && splitIndex < 10) { 
                    speaker = line.substring(0, splitIndex).trim();
                    content = line.substring(splitIndex + 1).trim();
                    lastSpeaker = speaker;
                }

                currentLines.push({ type: 'dialogue', speaker, content });
                i++;
            }
            saveCurrentBlock();
            return data;
        };

        // 解析包含多个小说的文本
        const parseAllStories = (fullText) => {
            const stories = [];
            // 使用正则匹配 <NOVEL ...> ... </NOVEL>
            const novelRegex = /<NOVEL\s+title="([^"]+)"(?:\s+[^>]*)?>([\s\S]*?)<\/NOVEL>/g;
            let match;

            while ((match = novelRegex.exec(fullText)) !== null) {
                const title = match[1];
                const content = match[2];
                const parsedData = parseSingleScriptData(content);
                
                // 提取预览文本（第一句台词或状态）
                let preview = "点击查看详情";
                if (parsedData.startSceneId && parsedData.scenes[parsedData.startSceneId]) {
                    const firstLines = parsedData.scenes[parsedData.startSceneId].lines;
                    const firstContentLine = firstLines.find(l => l.type === 'dialogue' || l.type === 'state');
                    if (firstContentLine) {
                        preview = firstContentLine.content;
                    }
                }

                stories.push({
                    id: `story_${stories.length}`,
                    title: title,
                    preview: preview,
                    data: parsedData
                });
            }
            return stories;
        };

        // 头像颜色工具
        const getAvatarColor = (name) => {
            const colors = ['bg-blue-400', 'bg-red-400', 'bg-yellow-400', 'bg-purple-400', 'bg-pink-400', 'bg-indigo-400', 'bg-teal-400', 'bg-orange-400'];
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        };

        // 头像组件
        const Avatar = ({ speaker, isSquare = false }) => {
            const roundedClass = isSquare ? "rounded-lg" : "rounded-md";
            if (speaker === '我') {
                return (
                    <div className={`w-10 h-10 ${roundedClass} bg-gray-200 overflow-hidden flex-shrink-0 border border-gray-300`}>
                        <svg className="w-full h-full text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                );
            } else if (speaker === '旁白') {
                return (
                    <div className={`w-10 h-10 ${roundedClass} bg-black flex items-center justify-center flex-shrink-0`}>
                        <span className="text-white font-bold text-lg">?</span>
                    </div>
                );
            } else {
                return (
                    <div className={`w-10 h-10 ${roundedClass} ${getAvatarColor(speaker)} flex items-center justify-center text-white font-bold text-sm flex-shrink-0`}>
                        {speaker.charAt(0)}
                    </div>
                );
            }
        };

        // --- 主程序组件 ---
        function WeChatFictionReader() {
            // View State: 'list' (WeChat Home) or 'reader' (Chat)
            const [currentView, setCurrentView] = useState('list');
            const [storiesList, setStoriesList] = useState([]);

            // Game Data State
            const [storyData, setStoryData] = useState(null);
            const [activeStoryTitle, setActiveStoryTitle] = useState("");
            const [messageHistory, setMessageHistory] = useState([]);
            
            // Execution State
            const [currentBlock, setCurrentBlock] = useState([]);
            const [lineIndex, setLineIndex] = useState(0);
            const [waitingForChoice, setWaitingForChoice] = useState(null);
            const [lastChoicePoint, setLastChoicePoint] = useState(null);
            
            // Ending State
            const [pendingEnding, setPendingEnding] = useState(null); // 待处理的结局（最后一句显示完，还没弹窗）
            const [endingInfo, setEndingInfo] = useState(null); // 已显示的结局弹窗
            
            // UI State
            const [isTyping, setIsTyping] = useState(false);
            const [typingSpeaker, setTypingSpeaker] = useState('');
            const [showMenu, setShowMenu] = useState(false);
            
            // Refs
            const fileInputRef = useRef(null);
            const chatEndRef = useRef(null);
            const autoPlayTimerRef = useRef(null);
            const endingTimerRef = useRef(null);
            const processNextLineRef = useRef(() => {});

            const ME = '我';

            // 初始加载 content.txt
            useEffect(() => {
                fetch('./content.txt')
                    .then(res => {
                        if (!res.ok) throw new Error("Failed to load content.txt");
                        return res.text();
                    })
                    .then(text => {
                        const stories = parseAllStories(text);
                        setStoriesList(stories);
                    })
                    .catch(err => {
                        console.log("Could not load local content.txt (probably CORS or missing file). Waiting for manual upload.", err);
                        // 如果加载失败，保持空列表，依赖“文件传输助手”
                    });
            }, []);

            // 滚动到底部
            useEffect(() => {
                if (currentView === 'reader') {
                    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messageHistory, isTyping, waitingForChoice, currentView]);

            // 清理定时器
            const clearAllTimers = () => {
                if (autoPlayTimerRef.current) clearTimeout(autoPlayTimerRef.current);
                if (endingTimerRef.current) clearTimeout(endingTimerRef.current);
                autoPlayTimerRef.current = null;
                endingTimerRef.current = null;
            };

            // 处理结局确认
            const finalizeEnding = (endingLine) => {
                setPendingEnding(null);
                setEndingInfo({
                    title: endingLine.endingTitle || '结局',
                    eval: endingLine.endingEval || '暂无评价'
                });
            };

            // 下一行逻辑处理
            const processNextLine = () => {
                if (!storyData) return;
                
                // 如果有待处理的结局，说明上一句是最后一句，现在点击了屏幕 -> 立即触发结局
                if (pendingEnding) {
                    clearAllTimers();
                    finalizeEnding(pendingEnding);
                    return;
                }

                if (lineIndex >= currentBlock.length) return; 
                if (isTyping || waitingForChoice || endingInfo) return; 

                const line = currentBlock[lineIndex];

                if (line.type === 'goto') {
                    if (line.targetScene && storyData.scenes[line.targetScene]) {
                        setCurrentBlock(storyData.scenes[line.targetScene].lines);
                        setLineIndex(0);
                        setTimeout(() => processNextLineRef.current(), 0); 
                    }
                    return;
                }

                if (line.type === 'choice') {
                    setWaitingForChoice(line.options || []);
                    setLineIndex(prev => prev + 1);
                    return;
                }

                if (line.type === 'ending') {
                    // === 优化点3：结局前的缓冲 ===
                    setPendingEnding(line);
                    // 3秒后自动弹出
                    endingTimerRef.current = setTimeout(() => {
                        finalizeEnding(line);
                    }, 3000);
                    // 注意：这里不增加 setLineIndex，因为结局行本身不产生对话气泡
                    return;
                }

                if (line.type === 'dialogue') {
                    setIsTyping(true);
                    setTypingSpeaker(line.speaker || '旁白');

                    setTimeout(() => {
                        setIsTyping(false);
                        setMessageHistory(prev => [
                            ...prev,
                            {
                                id: Date.now(),
                                speaker: line.speaker || '旁白',
                                content: line.content || '...',
                                isMe: (line.speaker === ME),
                                type: 'text'
                            }
                        ]);
                        setLineIndex(prev => prev + 1);

                        clearAllTimers();
                        autoPlayTimerRef.current = setTimeout(() => {
                            triggerAutoAdvance();
                        }, 3000);

                    }, 1000);
                } 
                else if (line.type === 'state') {
                    setMessageHistory(prev => [
                        ...prev,
                        { id: Date.now(), speaker: 'System', content: line.content || '', isMe: false, type: 'state' }
                    ]);
                    setLineIndex(prev => prev + 1);
                    setTimeout(() => processNextLineRef.current(), 50);
                }
            };

            useEffect(() => { processNextLineRef.current = processNextLine; });
            const triggerAutoAdvance = () => { processNextLineRef.current(); };

            // --- 交互处理 ---

            const handleScreenClick = () => {
                if (currentView !== 'reader') return;
                
                // 如果正在等待结局弹出（最后一句刚说完），点击屏幕立即弹出
                if (pendingEnding) {
                    clearAllTimers();
                    finalizeEnding(pendingEnding);
                    return;
                }

                clearAllTimers(); // 停止自动播放倒计时
                processNextLine(); // 立即执行下一行
            };

            const handleChoice = (option) => {
                if (!storyData) return;
                setLastChoicePoint({ messageHistory: [...messageHistory], choices: waitingForChoice });
                setMessageHistory(prev => [...prev, { id: Date.now(), speaker: ME, content: option.text, isMe: true, type: 'text' }]);
                setWaitingForChoice(null);
                const branchBlock = storyData.branches[option.id];
                if (branchBlock) {
                    setCurrentBlock(branchBlock.lines);
                    setLineIndex(0);
                    setTimeout(() => triggerAutoAdvance(), 500);
                }
            };

            const handleBackToChoice = () => {
                if (lastChoicePoint) {
                    setMessageHistory(lastChoicePoint.messageHistory);
                    setWaitingForChoice(lastChoicePoint.choices);
                    setEndingInfo(null);
                    setPendingEnding(null);
                    setCurrentBlock([]); 
                    setLineIndex(0);
                    clearAllTimers();
                }
            };

            // 打开特定小说
            const openStory = (story) => {
                setStoryData(story.data);
                setActiveStoryTitle(story.title);
                setCurrentBlock(story.data.scenes[story.data.startSceneId].lines);
                setLineIndex(0);
                setMessageHistory([]); 
                setWaitingForChoice(null);
                setEndingInfo(null);
                setPendingEnding(null);
                setLastChoicePoint(null);
                setCurrentView('reader');
                setTimeout(() => triggerAutoAdvance(), 500);
            };

            // 文件传输助手逻辑（即上传）
            const handleFileUpload = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target?.result;
                    // 这里假设上传的是单文件格式，但也兼容包含 NOVEL 标签的
                    let parsed;
                    if (text.includes('<NOVEL')) {
                         const stories = parseAllStories(text);
                         if(stories.length > 0) parsed = stories[0].data; // 只取第一个作为演示
                    } else {
                        parsed = parseSingleScriptData(text);
                    }

                    if (parsed && parsed.startSceneId) {
                        openStory({ title: file.name.replace(/\.[^/.]+$/, ""), data: parsed });
                    } else {
                        alert("无法解析文件。");
                    }
                };
                reader.readAsText(file);
            };

            const handleBackToList = () => {
                clearAllTimers();
                setCurrentView('list');
                setStoryData(null);
            };

            const restartGame = () => {
                if (storyData && storyData.startSceneId) {
                    setCurrentBlock(storyData.scenes[storyData.startSceneId].lines);
                    setLineIndex(0);
                    setMessageHistory([]);
                    setWaitingForChoice(null);
                    setEndingInfo(null);
                    setPendingEnding(null);
                    setLastChoicePoint(null);
                    clearAllTimers();
                    setShowMenu(false);
                    setTimeout(() => triggerAutoAdvance(), 500);
                }
            };

            // --- 渲染部分 ---

            // 1. 列表视图 (微信首页)
            if (currentView === 'list') {
                return (
                    <div className="flex justify-center items-center w-full h-screen bg-gray-900 font-sans">
                        <div className="w-full h-full max-w-md bg-white flex flex-col relative overflow-hidden shadow-2xl">
                            {/* 微信头部 */}
                            <header className="bg-[#EDEDED] h-[52px] flex items-center justify-between px-4 sticky top-0 z-10">
                                <span className="font-medium text-[17px] text-[#181818]">微信</span>
                                <div className="flex space-x-4 text-[#181818]">
                                    <SearchIcon />
                                    <PlusIcon />
                                </div>
                            </header>

                            {/* 列表内容 */}
                            <div className="flex-1 overflow-y-auto">
                                {/* 文件传输助手 (上传入口) */}
                                <div 
                                    className="flex items-center px-4 py-3 active:bg-[#EDEDED]"
                                    onClick={() => fileInputRef.current?.click()}
                                >
                                    <div className="w-12 h-12 rounded-lg bg-green-500 flex items-center justify-center text-white shrink-0">
                                        <FileIcon size={28} />
                                    </div>
                                    <div className="ml-3 flex-1 h-12 flex flex-col justify-between border-b border-gray-100 pb-3 box-content">
                                        <div className="flex justify-between items-center mt-0.5">
                                            <h3 className="text-[17px] font-normal text-black">文件传输助手</h3>
                                            <span className="text-[10px] text-gray-400">刚刚</span>
                                        </div>
                                        <p className="text-[14px] text-gray-400 truncate">
                                            [点击此处上传本地剧本文件]
                                        </p>
                                    </div>
                                </div>

                                {/* 隐藏的文件输入 */}
                                <input
                                    type="file"
                                    accept=".csv,.txt,.xml"
                                    ref={fileInputRef}
                                    className="hidden"
                                    onChange={handleFileUpload}
                                />

                                {/* 本地小说列表 */}
                                {storiesList.map((story) => (
                                    <div 
                                        key={story.id}
                                        className="flex items-center px-4 py-3 active:bg-[#EDEDED]"
                                        onClick={() => openStory(story)}
                                    >
                                        <div className={`w-12 h-12 rounded-lg ${getAvatarColor(story.title)} flex items-center justify-center text-white font-bold text-lg shrink-0`}>
                                            {story.title.charAt(0)}
                                        </div>
                                        <div className="ml-3 flex-1 h-12 flex flex-col justify-between border-b border-gray-100 pb-3 box-content">
                                            <div className="flex justify-between items-center mt-0.5">
                                                <h3 className="text-[17px] font-normal text-black">{story.title}</h3>
                                                <span className="text-[10px] text-gray-400">昨天</span>
                                            </div>
                                            <p className="text-[14px] text-gray-400 truncate">
                                                {story.preview}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* 底部导航栏 (装饰用) */}
                            <footer className="h-[56px] bg-[#F7F7F7] border-t border-gray-200 flex items-center justify-around pb-safe">
                                <div className="flex flex-col items-center justify-center text-[#07C160]">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                                    <span className="text-[10px] mt-0.5">微信</span>
                                </div>
                                <div className="flex flex-col items-center justify-center text-gray-400">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                    <span className="text-[10px] mt-0.5">通讯录</span>
                                </div>
                                <div className="flex flex-col items-center justify-center text-gray-400">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>
                                    <span className="text-[10px] mt-0.5">发现</span>
                                </div>
                                <div className="flex flex-col items-center justify-center text-gray-400">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                    <span className="text-[10px] mt-0.5">我</span>
                                </div>
                            </footer>
                        </div>
                    </div>
                );
            }

            // 2. 阅读器视图
            return (
                <div className="flex justify-center items-center w-full h-screen bg-gray-900 font-sans">
                    <div className="w-full h-full max-w-md bg-[#F5F5F5] flex flex-col relative overflow-hidden shadow-2xl animate-in slide-in-right">
                        
                        {/* 顶部栏 */}
                        <header className="bg-[#EDEDED] h-[48px] flex items-center justify-between px-3 border-b border-gray-300 z-20 shrink-0 select-none">
                            <div className="flex items-center cursor-pointer" onClick={handleBackToList}>
                                <ChevronLeft className="text-black" size={26} />
                                <span className="font-medium text-[16px] text-black ml-1">{activeStoryTitle}</span>
                            </div>
                            <button onClick={() => setShowMenu(!showMenu)} className="p-2 rounded-md hover:bg-gray-200">
                                <MoreHorizontal className="text-black" />
                            </button>
                        </header>

                        {/* 菜单 */}
                        {showMenu && (
                            <div className="absolute top-12 right-2 bg-[#4C4C4C] rounded-lg shadow-xl z-50 py-2 w-40 text-white animate-in">
                                <button onClick={restartGame} className="flex items-center px-4 py-3 w-full hover:bg-[#5C5C5C] border-b border-[#5C5C5C]">
                                    <RotateCcw size={18} className="mr-3" />
                                    重新开始
                                </button>
                                <button onClick={handleBackToList} className="flex items-center px-4 py-3 w-full hover:bg-[#5C5C5C]">
                                    <svg width="18" height="18" className="mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                    退出阅读
                                </button>
                            </div>
                        )}

                        {/* 聊天区域 */}
                        <div 
                            className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar bg-[#F5F5F5]" 
                            onClick={handleScreenClick}
                        >
                            {messageHistory.map((msg) => {
                                if (msg.type === 'state') {
                                    return (
                                        <div key={msg.id} className="flex justify-center py-2">
                                            <span className="bg-[#DADADA] text-white text-xs px-2 py-1 rounded-sm">
                                                {msg.content}
                                            </span>
                                        </div>
                                    );
                                }

                                return (
                                    <div key={msg.id} className={`flex w-full mb-4 ${msg.isMe ? 'justify-end' : 'justify-start'}`}>
                                        {!msg.isMe && <Avatar speaker={msg.speaker} isSquare={true} />}
                                        
                                        <div className={`mx-2 max-w-[70%] relative`}>
                                            {!msg.isMe && msg.speaker !== '旁白' && (
                                                <p className="text-gray-500 text-xs mb-1 ml-1">{msg.speaker}</p>
                                            )}
                                            
                                            <div className={`px-3 py-2 rounded-lg text-black text-[15px] leading-relaxed break-words relative 
                                                ${msg.isMe ? 'bg-[#95ec69]' : 'bg-white'} 
                                                shadow-sm border border-gray-200/50`}>
                                                
                                                {/* 气泡箭头 */}
                                                <div className={`absolute top-[10px] w-2 h-2 transform rotate-45 
                                                    ${msg.isMe ? '-right-1 bg-[#95ec69]' : '-left-1 bg-white'}
                                                `}></div>
                                                
                                                {msg.content}
                                            </div>
                                        </div>

                                        {msg.isMe && <Avatar speaker={msg.speaker} isSquare={true} />}
                                    </div>
                                );
                            })}

                            {/* 输入中指示器 */}
                            {isTyping && (
                                <div className={`flex w-full mb-4 justify-start`}>
                                    <Avatar speaker={typingSpeaker} isSquare={true} />
                                    <div className="mx-2 bg-white px-4 py-3 rounded-lg shadow-sm flex items-center space-x-1 h-[40px] relative">
                                         <div className="absolute top-[10px] -left-1 w-2 h-2 transform rotate-45 bg-white"></div>
                                        <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></div>
                                        <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></div>
                                        <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></div>
                                    </div>
                                </div>
                            )}

                            <div ref={chatEndRef} className="h-4" />
                        </div>

                        {/* 底部输入/选项区域 */}
                        <div className="bg-[#F7F7F7] border-t border-[#DCDCDC] p-2 min-h-[50px] shrink-0 flex items-center justify-center safe-area-pb">
                            {waitingForChoice ? (
                                <div className="w-full flex flex-col space-y-2 p-1">
                                    {waitingForChoice.map((option) => (
                                        <button
                                            key={option.id}
                                            onClick={(e) => { e.stopPropagation(); handleChoice(option); }}
                                            className="w-full bg-white active:bg-gray-100 text-black py-3 rounded-md border border-gray-200 text-sm font-medium shadow-sm transition-colors"
                                        >
                                            {option.text}
                                        </button>
                                    ))}
                                </div>
                            ) : (
                                <div 
                                    className="w-full bg-white h-10 rounded-md border border-[#DCDCDC] flex items-center justify-center text-gray-400 text-sm active:bg-gray-50 select-none cursor-pointer"
                                    onClick={handleScreenClick}
                                >
                                    点击屏幕继续...
                                </div>
                            )}
                        </div>

                        {/* 结局弹窗 */}
                        {endingInfo && (
                            <div className="absolute inset-0 z-50 bg-gray-900/40 backdrop-blur-md flex items-center justify-center p-6 animate-in">
                                <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden zoom-in-95 border border-gray-100">
                                    <div className="px-8 pt-10 pb-6 text-center">
                                        <p className="text-xs font-bold tracking-widest text-[#FF2D55] uppercase mb-3">
                                            The End
                                        </p>
                                        <h2 className="text-3xl font-serif font-bold text-gray-900 leading-tight mb-4">
                                            {endingInfo.title}
                                        </h2>
                                        <div className="w-12 h-1 bg-gray-100 mx-auto mb-6"></div>
                                        <p className="text-gray-500 font-sans text-lg leading-relaxed">
                                            {endingInfo.eval}
                                        </p>
                                    </div>

                                    <div className="p-6 pt-0 flex flex-col gap-3">
                                        <button 
                                            onClick={restartGame}
                                            className="w-full bg-black hover:bg-gray-800 text-white font-semibold py-3.5 rounded-xl transition-all shadow-lg shadow-gray-200"
                                        >
                                            重新游玩
                                        </button>
                                        
                                        {lastChoicePoint && (
                                            <button 
                                                onClick={handleBackToChoice}
                                                className="w-full bg-gray-100 hover:bg-gray-200 text-gray-900 font-semibold py-3.5 rounded-xl transition-colors"
                                            >
                                                回到上一个选择点
                                            </button>
                                        )}

                                        <button 
                                            onClick={handleBackToList}
                                            className="w-full bg-gray-100 hover:bg-gray-200 text-gray-900 font-semibold py-3.5 rounded-xl transition-colors"
                                        >
                                            返回列表
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WeChatFictionReader />);
    </script>
</body>
</html>
